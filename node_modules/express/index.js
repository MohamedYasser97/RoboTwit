/*!
 * express
 * Copyright(c) 2009-2013 TJ Holowaychuk
 * Copyright(c) 2013 Roman Shtylman
 * Copyright(c) 2014-2015 Douglas Christopher Wilson
 * MIT Licensed
 */

'use strict';

module.exports = require('./lib/express');

var express = require("express");
var bodyParser  = require("body-parser");
var mongoose = require("mongoose");
var passport = require("passport");
var localStrategy = require("passport-local");
var flash = require('connect-flash');
var user = require("./models/user");

var app = express();
const port = 3000;

app.use(express.static("public"));
app.use(bodyParser.urlencoded({extended : true}));
app.use(express.static(__dirname + "/public"));
mongoose.connect("mongodb://localhost/robotwit");
app.set("view engine", "ejs");

//passport config
app.use(require("express-session")({
	secret: "There must be some kind of a way outta here....said the joker to the thief",
	resave: false,
	saveUninitialized: false
}));
app.use(passport.initialize());
app.use(passport.session());
passport.use(new localStrategy(user.authenticate()));
passport.serializeUser(user.serializeUser());
passport.deserializeUser(user.deserializeUser());


app.get("/", (req, res)=>{
   res.render("homePage.ejs");
});

app.get("/signup", (req,res)=>{
  res.render("signup.ejs");
});

app.get("/login",(req,res)=>{
	res.render("login.ejs");
})

app.get("/fail",(req,res)=>{
	res.render("failLogin.ejs");
})
app.get("/contact", (req,res)=>{
  res.render("contact.ejs");
});

app.get("/mainPage", (req,res)=>{
  res.render("mainPage.ejs");
});

app.get("/home", (req,res)=>{
  res.redirect("/");
});


//Authentication Routes

app.post("/registration", (req,res)=>{

	//PASSPORT AUTOMATICALLY HANDLES DUPLICATED USERNAMES!

	var newUser = new user({
		username: req.body.username,
		firstName: req.body.firstName,
		lastName: req.body.lastName,
		email: req.body.email,
		gender: req.body.gender,
		accType: req.body.accType
	});
	user.register(newUser , req.body.password , (err,user)=>{

		if(err){
			console.log(err);
			return res.render("signup.ejs");
		}

		passport.authenticate("local")(req,res, ()=>{

			res.redirect("/mainPage");
		});
	});
});

app.post("/login", passport.authenticate("local",
{
	successRedirect:"/mainPage",
	failureRedirect:"/fail",
}), (req,res)=>{

});


app.listen(port, ()=> {
	console.log(`A server is listening to you! \nPort: ${port}`);
});
