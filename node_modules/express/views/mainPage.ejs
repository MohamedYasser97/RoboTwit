<!DOCTYPE html>
<html>
<head>
  <title>RoboTwit</title>

  <link rel="stylesheet" type="text/css" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.2/Chart.bundle.js"></script>
  <link rel="stylesheet" type="text/css" href="mainpage.css">
</head>
<body>

<% include partials/header %>

<div class="container-fluid" id="pageContainer">

  <div class="row">
    <div class="col-3 md">
      <div class="card">
             <div class="card-body" class="smallGraph">
           <canvas id="retweetChart"  ></canvas>

         </div>
       </div>
       <div class="card" class="smallGraph">
              <div class="card-body">
            <canvas id="likesChart" ></canvas>

          </div>
        </div>
        <div class="card" class="smallGraph">
               <div class="card-body">
             <canvas id="Canvas3"></canvas>

           </div>
         </div>
    </div>

    <div class="col-5 md">
      <div class="card" id="tweet">
          <div class="card-body" id="tweetBody">

          </div>
      </div>
    </div>

    <div class="col-4 md">
      <div class="card">
             <div class="card-body">
           <canvas id="Canvas1" ></canvas>

         </div>
       </div>
    </div>
  </div>
</div>







  <script
    src="https://code.jquery.com/jquery-3.3.1.min.js"
    integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.bundle.min.js" integrity="sha384-pjaaA8dDz/5BgdFUPX6M/9SUZv4d12SUPF0axWc+VRZkx5xU3daN+lYb49+Ax+Tl" crossorigin="anonymous"></script>
  <script>

  var ctx = document.getElementById("retweetChart");
  var retweetChart = new Chart(ctx, {
  type: 'bar',
  data: {
  labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
  datasets: [{
   label: '# of Votes',
   data: [12, 19, 3, 5, 2, 3],
   backgroundColor: [
       'rgba(255, 99, 132, 0.2)',
       'rgba(54, 162, 235, 0.2)',
       'rgba(255, 206, 86, 0.2)',
       'rgba(75, 192, 192, 0.2)',
       'rgba(153, 102, 255, 0.2)',
       'rgba(255, 159, 64, 0.2)'
   ],
   borderColor: [
       'rgba(255,99,132,1)',
       'rgba(54, 162, 235, 1)',
       'rgba(255, 206, 86, 1)',
       'rgba(75, 192, 192, 1)',
       'rgba(153, 102, 255, 1)',
       'rgba(255, 159, 64, 1)'
   ],
   borderWidth: 1
  }]
  },
  options: {
  scales: {
   yAxes: [{
       ticks: {
           beginAtZero:true
       }
   }]
  }
  }
});
  </script>

  <script type="text/javascript">

    function createGraph(chartName,myData){

        var ctx = document.getElementById(chartName);
        var chart = new Chart(ctx, {
        type: 'bar',
        data: {
        labels: ["Red", "Blue", "Yellow", "Green", "Purple", "Orange"],
        datasets: [{
         label: '# of Votes',
         data: myData,
         backgroundColor: [
             'rgba(255, 99, 132, 0.2)',
             'rgba(54, 162, 235, 0.2)',
             'rgba(255, 206, 86, 0.2)',
             'rgba(75, 192, 192, 0.2)',
             'rgba(153, 102, 255, 0.2)',
             'rgba(255, 159, 64, 0.2)'
         ],
         borderColor: [
             'rgba(255,99,132,1)',
             'rgba(54, 162, 235, 1)',
             'rgba(255, 206, 86, 1)',
             'rgba(75, 192, 192, 1)',
             'rgba(153, 102, 255, 1)',
             'rgba(255, 159, 64, 1)'
         ],
         borderWidth: 1
        }]
        },
        options: {
        scales: {
         yAxes: [{
             ticks: {
                 beginAtZero:true
             }
         }]
        }
        }
      });
    }

    function updateGraphs(tweetId){
console.log('updating graphs');

        $.ajax
            ({
               type: "get",
               url: "/mainPage/update",
               data : `tweetId=${tweetId}`,
               contentType: "application/json; charset=UTF-8",

            }).done(function ( labels ) {

                  var data = [];

                  labels.forEach(function(obj){
                      data.push(obj);
                  });

                  createGraph('retweetChart', data);
                  createGraph('likesChart', data);
console.log('graphs updated');
            });
    }

    (function refresh() {console.log('entered ajax');
          $.ajax
            ({
               type: "get",
               url: "/mainPage/refresh",

               contentType: "application/json; charset=UTF-8",

            }).done(function ( tweets ) {

                  console.log("Search for tweets completed");
                  //TODO add tweets

                  var tweetspace=document.getElementById("tweetBody");
                  var tweetTag='';

                  tweets.forEach(function(obj){
                      tweetTag += `<div id =${obj} onclick="updateGraphs('${obj}')"><blockquote class='twitter-tweet' data-lang='en'><a href='https://twitter.com/<%=currentUser.username%>/status/${obj}'></a></blockquote></div>`;

                  });

                  tweetspace.innerHTML = tweetTag;

                  $('<script>').attr('src', "https://platform.twitter.com/widgets.js").appendTo('body');

            }).then(function() {
             setTimeout(refresh, 60000);
          });
      })();

  </script>
  <script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>

</body>
</html>
